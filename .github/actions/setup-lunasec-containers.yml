name: 'Setup LunaSec Docker Containers'
description: 'Creates and builds the LunaSec Docker containers'

#outputs:
#  :
#    description: "Random number"
#    value: ${{ steps.random-number-generator.outputs.random-id }}
runs:
  using: "composite"
  env:
    # avoid warnings like "tput: No value for $TERM and no -T specified"
    TERM: xterm
    DOCKER_BUILDKIT: 1
    COMPOSE_DOCKER_CLI_BUILD: 1
  steps:
    #TODO: there may be a more idiomatic way to do this
    - name: Check if we should skip this build
      id: job-canceller
      run: echo "::set-output name=cancelled::${{ inputs.merge-master == true && github.event_name != 'pull_request'}}"

    # Cancel the merge copy of this build(see the matrix above) if we are not in a PR
    - name: cancelling
      uses: andymckay/cancel-action@0.2
      if: ${{ steps.job-canceller.outputs.cancelled == 'true' }}

      # merge with master(or whatever target branch) so we are actually testing what will happen after PR merges, not just this branch
    - name: Merge target branch
      run: git merge origin/${{ github.event.pull_request.base.ref }}
      if: ${{ inputs.merge-master == true && github.event_name == 'pull_request' }}

    - name: Set up Docker BuildKit
      id: buildx
      uses: docker/setup-buildx-action@v1
      with:
        install: true # sets buildx as the default for docker, which should apply to docker-compose commands
        driver: docker

    - uses: actions/setup-node@v2
      with:
        node-version: '14'
        cache: yarn

    # Enable tmate debugging of manually-triggered workflows if the input option was provided
    - name: Setup tmate session
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.debug_enabled != 'false' }}
      timeout-minutes: 15

    # specifically tag this bootstrap container to prevent rebuilds
    - name: Build Lerna Bootstrap container
      run: docker build --progress plain -f ./js/docker/demo.dockerfile -t lerna-bootstrap --target lerna-bootstrap .

    - name: Build CLI Container
      run: docker build --progress plain -f ./js/docker/demo.dockerfile -t repo_lunasec-cli --target lunasec-cli .
